<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Checkout - FitZone</title>
        <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%234b1c71'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='%23dbb6ee' font-family='Arial, sans-serif' font-weight='bold'>F</text></svg>">
        <link rel="stylesheet" href="/css/style.css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <nav class="navbar">
                <div class="nav-container">
                    <div class="logo">
                        <i class="fas fa-dumbbell"></i>
                        <span>FitZone</span>
                    </div>
                    <ul class="nav-menu">
                        <li><a href="/tienda">Volver a Tienda</a></li>
                        <li><a href="/dashboard">Dashboard</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Main Checkout -->
        <main class="checkout-main">
            <div class="container">
                <div class="checkout-header">
                    <h1>Finalizar Compra</h1>
                    <p>Completa los datos para recibir tu pedido</p>
                </div>

                <div class="checkout-container">
                    <!-- Formulario de Checkout -->
                    <div class="checkout-form-section">
                        <!-- Progress Steps -->
                        <div class="checkout-steps">
                            <div class="checkout-step active" data-step="1">
                                <div class="step-number">1</div>
                                <span>Datos</span>
                            </div>
                            <div class="checkout-line"></div>
                            <div class="checkout-step" data-step="2">
                                <div class="step-number">2</div>
                                <span>Envío</span>
                            </div>
                            <div class="checkout-line"></div>
                            <div class="checkout-step" data-step="3">
                                <div class="step-number">3</div>
                                <span>Pago</span>
                            </div>
                        </div>

                        <!-- Step 1: Datos del Cliente -->
                        <div id="checkout-step-1" class="checkout-step-content active">
                            <h3>Datos de Contacto</h3>
                            <form id="contact-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="checkout-name">Nombre Completo *</label>
                                        <input type="text" id="checkout-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="checkout-email">Email *</label>
                                        <input type="email" id="checkout-email" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="checkout-phone">Teléfono *</label>
                                        <input type="tel" id="checkout-phone" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="checkout-dni">DNI *</label>
                                        <input type="text" id="checkout-dni" required>
                                    </div>
                                </div>
                                <div class="checkout-actions">
                                    <button type="button" class="btn-secondary" onclick="window.location.href='/tienda'">
                                        Volver a Tienda
                                    </button>
                                    <button type="button" class="btn-primary" onclick="goToCheckoutStep(2)">
                                        Continuar <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 2: Método de Envío -->
                        <div id="checkout-step-2" class="checkout-step-content">
                            <h3>Método de Envío</h3>
                            <div class="shipping-options">
                                <label class="shipping-option">
                                    <input type="radio" name="shipping" value="domicilio" checked>
                                    <div class="shipping-card">
                                        <div class="shipping-info">
                                            <i class="fas fa-truck"></i>
                                            <div>
                                                <h4>Envío a Domicilio</h4>
                                                <p>Recibe tu pedido en la puerta de tu casa</p>
                                                <small>Tiempo estimado: 3-5 días hábiles</small>
                                            </div>
                                        </div>
                                        <div class="shipping-price">$3.000</div>
                                    </div>
                                </label>

                                <label class="shipping-option">
                                    <input type="radio" name="shipping" value="sucursal">
                                    <div class="shipping-card">
                                        <div class="shipping-info">
                                            <i class="fas fa-store"></i>
                                            <div>
                                                <h4>Sucursal más Cercana</h4>
                                                <p>Retira en la sucursal de correo más cercana</p>
                                                <small>Tiempo estimado: 2-4 días hábiles</small>
                                            </div>
                                        </div>
                                        <div class="shipping-price">$2.000</div>
                                    </div>
                                </label>

                                <label class="shipping-option">
                                    <input type="radio" name="shipping" value="fitzone">
                                    <div class="shipping-card">
                                        <div class="shipping-info">
                                            <i class="fas fa-dumbbell"></i>
                                            <div>
                                                <h4>Retiro en FitZone</h4>
                                                <p>Retira personalmente en nuestro gimnasio</p>
                                                <small>Disponible de Lun a Sáb</small>
                                            </div>
                                        </div>
                                        <div class="shipping-price">GRATIS</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Dirección de Envío -->
                            <div id="shipping-address-section" style="margin-top: 2rem;">
                                <h3>Dirección de Entrega</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="address-street">Calle y Número *</label>
                                        <input type="text" id="address-street" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="address-floor">Piso/Depto</label>
                                        <input type="text" id="address-floor">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="address-city">Ciudad *</label>
                                        <input type="text" id="address-city" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="address-province">Provincia *</label>
                                        <input type="text" id="address-province" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="address-zipcode">Código Postal *</label>
                                        <input type="text" id="address-zipcode" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="address-notes">Indicaciones adicionales</label>
                                    <textarea id="address-notes" rows="3" placeholder="Ej: Portón azul, timbre 2B"></textarea>
                                </div>
                            </div>

                            <div class="checkout-actions">
                                <button type="button" class="btn-secondary" onclick="goToCheckoutStep(1)">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </button>
                                <button type="button" class="btn-primary" onclick="goToCheckoutStep(3)">
                                    Continuar <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Método de Pago -->
                        <div id="checkout-step-3" class="checkout-step-content">
                            <h3>Método de Pago</h3>
                            <div class="payment-methods-checkout">
                                <label class="payment-option-checkout">
                                    <input type="radio" name="payment" value="efectivo" checked>
                                    <div class="payment-card-checkout">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <div>
                                            <h4>Efectivo</h4>
                                            <p>Paga al recibir el pedido</p>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option-checkout">
                                    <input type="radio" name="payment" value="transferencia">
                                    <div class="payment-card-checkout">
                                        <i class="fas fa-university"></i>
                                        <div>
                                            <h4>Transferencia Bancaria</h4>
                                            <p>Te enviaremos los datos por email</p>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option-checkout">
                                    <input type="radio" name="payment" value="tarjeta">
                                    <div class="payment-card-checkout">
                                        <i class="fas fa-credit-card"></i>
                                        <div>
                                            <h4>Tarjeta de Crédito/Débito</h4>
                                            <p>Pago seguro online</p>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option-checkout">
                                    <input type="radio" name="payment" value="mercadopago">
                                    <div class="payment-card-checkout">
                                        <i class="fas fa-shopping-cart"></i>
                                        <div>
                                            <h4>Mercado Pago</h4>
                                            <p>Recargo del 5%</p>
                                        </div>
                                        <span class="recargo-badge">+5%</span>
                                    </div>
                                </label>
                            </div>

                            <div class="checkout-actions">
                                <button type="button" class="btn-secondary" onclick="goToCheckoutStep(2)">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </button>
                                <button type="button" class="btn-primary" onclick="completePurchase()">
                                    <i class="fas fa-check"></i> Confirmar Compra
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de Pedido -->
                    <div class="order-summary">
                        <h3>Resumen del Pedido</h3>
                        
                        <div class="summary-items" id="summary-items">
                            <!-- Los items se cargan dinámicamente -->
                        </div>

                        <div class="summary-totals">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <strong id="summary-subtotal">$0</strong>
                            </div>
                            <div class="summary-row">
                                <span>Envío:</span>
                                <strong id="summary-shipping">$0</strong>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <strong id="summary-total">$0</strong>
                            </div>
                        </div>

                        <div class="summary-benefits">
                            <h4>Beneficios de tu compra:</h4>
                            <ul>
                                <li><i class="fas fa-check"></i> Productos originales</li>
                                <li><i class="fas fa-check"></i> Garantía de calidad</li>
                                <li><i class="fas fa-check"></i> Envío seguro</li>
                                <li><i class="fas fa-check"></i> Soporte post-venta</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script src="/js/alerts.js"></script>
        <script>
            let cartItems = [];
            let currentStep = 1;
            let shippingCost = 3000;

            // Cargar al iniciar
            document.addEventListener('DOMContentLoaded', function() {
                loadCartFromCheckout();
                loadUserData();
                updateOrderSummary();
                setupShippingListeners();
                setupPaymentListeners();
            });

            // Cargar carrito
            function loadCartFromCheckout() {
                const cart = JSON.parse(localStorage.getItem('fitzone_cart') || '[]');
                if (cart.length === 0) {
                    showCustomAlert('warning', 'Carrito Vacío', 'Tu carrito está vacío. Serás redirigido a la tienda.', 
                        () => window.location.href = '/tienda'
                    );
                    return;
                }
                cartItems = cart;
                displayCartItems();
            }

            // Cargar datos del usuario
            async function loadUserData() {
                try {
                    const response = await fetch('/api/user');
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('checkout-name').value = data.user.fullName;
                        document.getElementById('checkout-email').value = data.user.email;
                        document.getElementById('checkout-phone').value = data.user.phone;
                    }
                } catch (error) {
                    console.log('No se pudieron cargar los datos del usuario');
                }
            }

            // Mostrar items del carrito
            function displayCartItems() {
                const container = document.getElementById('summary-items');
                
                container.innerHTML = cartItems.map(item => `
                    <div class="summary-item">
                        <div class="item-details">
                            <strong>${item.name}</strong>
                            <span>x${item.quantity}</span>
                        </div>
                        <div class="item-price">${(item.price * item.quantity).toLocaleString()}</div>
                    </div>
                `).join('');
            }

            // Actualizar resumen
            function updateOrderSummary() {
                const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Calcular recargo de Mercado Pago si está seleccionado
                const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
                let finalSubtotal = subtotal;
                if (paymentMethod === 'mercadopago') {
                    finalSubtotal = subtotal * 1.05;
                }
                
                const total = finalSubtotal + shippingCost;
                
                document.getElementById('summary-subtotal').textContent = `${Math.round(finalSubtotal).toLocaleString()}`;
                document.getElementById('summary-shipping').textContent = shippingCost === 0 ? 'GRATIS' : `${shippingCost.toLocaleString()}`;
                document.getElementById('summary-total').textContent = `${Math.round(total).toLocaleString()}`;
            }

            // Listeners de envío
            function setupShippingListeners() {
                const shippingOptions = document.querySelectorAll('input[name="shipping"]');
                const addressSection = document.getElementById('shipping-address-section');
                
                shippingOptions.forEach(option => {
                    option.addEventListener('change', function() {
                        // Actualizar costo de envío
                        switch(this.value) {
                            case 'domicilio':
                                shippingCost = 3000;
                                addressSection.style.display = 'block';
                                break;
                            case 'sucursal':
                                shippingCost = 2000;
                                addressSection.style.display = 'block';
                                break;
                            case 'fitzone':
                                shippingCost = 0;
                                addressSection.style.display = 'none';
                                break;
                        }
                        updateOrderSummary();
                    });
                });
            }

            // Listeners de pago
            function setupPaymentListeners() {
                const paymentOptions = document.querySelectorAll('input[name="payment"]');
                paymentOptions.forEach(option => {
                    option.addEventListener('change', function() {
                        updateOrderSummary();
                    });
                });
            }

            // Navegación entre pasos
            function goToCheckoutStep(step) {
                // Validar paso actual antes de avanzar
                if (!validateCheckoutStep(currentStep)) {
                    return;
                }

                // Ocultar todos los pasos
                document.querySelectorAll('.checkout-step-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Mostrar paso seleccionado
                document.getElementById(`checkout-step-${step}`).classList.add('active');

                // Actualizar indicadores
                document.querySelectorAll('.checkout-step').forEach(stepEl => {
                    const stepNum = parseInt(stepEl.dataset.step);
                    stepEl.classList.remove('active', 'completed');
                    
                    if (stepNum < step) {
                        stepEl.classList.add('completed');
                    } else if (stepNum === step) {
                        stepEl.classList.add('active');
                    }
                });

                currentStep = step;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Validar paso actual
            function validateCheckoutStep(step) {
                if (step === 1) {
                    const name = document.getElementById('checkout-name').value;
                    const email = document.getElementById('checkout-email').value;
                    const phone = document.getElementById('checkout-phone').value;
                    const dni = document.getElementById('checkout-dni').value;

                    if (!name || !email || !phone || !dni) {
                        showCustomAlert('warning', 'Datos Incompletos', 'Por favor completa todos los campos requeridos.');
                        return false;
                    }

                    // Validar email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showCustomAlert('error', 'Email Inválido', 'Por favor ingresa un email válido.');
                        return false;
                    }
                }

                if (step === 2) {
                    const shippingMethod = document.querySelector('input[name="shipping"]:checked').value;
                    
                    if (shippingMethod !== 'fitzone') {
                        const street = document.getElementById('address-street').value;
                        const city = document.getElementById('address-city').value;
                        const province = document.getElementById('address-province').value;
                        const zipcode = document.getElementById('address-zipcode').value;

                        if (!street || !city || !province || !zipcode) {
                            showCustomAlert('warning', 'Dirección Incompleta', 'Por favor completa los datos de dirección de envío.');
                            return false;
                        }
                    }
                }

                return true;
            }

            // Completar compra
            async function completePurchase() {
                if (!validateCheckoutStep(3)) {
                    return;
                }

                const purchaseData = {
                    customer: {
                        name: document.getElementById('checkout-name').value,
                        email: document.getElementById('checkout-email').value,
                        phone: document.getElementById('checkout-phone').value,
                        dni: document.getElementById('checkout-dni').value
                    },
                    shipping: {
                        method: document.querySelector('input[name="shipping"]:checked').value,
                        cost: shippingCost
                    },
                    payment: {
                        method: document.querySelector('input[name="payment"]:checked').value
                    },
                    items: cartItems
                };

                // Agregar dirección si corresponde
                if (purchaseData.shipping.method !== 'fitzone') {
                    purchaseData.shipping.address = {
                        street: document.getElementById('address-street').value,
                        floor: document.getElementById('address-floor').value,
                        city: document.getElementById('address-city').value,
                        province: document.getElementById('address-province').value,
                        zipcode: document.getElementById('address-zipcode').value,
                        notes: document.getElementById('address-notes').value
                    };
                }

                try {
                    const response = await fetch('/api/checkout/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(purchaseData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Limpiar carrito
                        localStorage.removeItem('fitzone_cart');
                        
                        // Mostrar confirmación
                        const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0) + shippingCost;
                        showCustomAlert('success', '¡Compra Exitosa!', 
                            `Tu pedido #${result.orderId} ha sido registrado exitosamente.<br><br>` +
                            `Total: ${Math.round(total).toLocaleString()}<br><br>` +
                            `Recibirás un email de confirmación en ${purchaseData.customer.email}`,
                            () => {
                                setTimeout(() => {
                                    window.location.href = '/dashboard';
                                }, 2000);
                            }
                        );
                    } else {
                        showCustomAlert('error', 'Error en la Compra', result.message || 'Hubo un problema al procesar tu compra.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showCustomAlert('error', 'Error de Conexión', 'No se pudo completar la compra. Verifica tu conexión e intenta nuevamente.');
                }
            }
        </script>
    </body>
</html>